<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Octo Task üêô</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

</head>

<body>

    <h1>Octo Task üêô</h1>

    <div class="smart-form">
        <form method="POST">
            <input type="text" id="task_title" name="task_title" placeholder="What is the mission?" required autocomplete="off">
            <div class="sliders-container" id="sliders-area">
                <div><label>Urgency <span id="val_urgency">5.0</span></label><input type="range" id="urgency" name="urgency" min="1"
                        max="10" step="0.1" value="5"></div>
                <div><label>Fear <span id="val_fear">5.0</span></label><input type="range" id="fear" name="fear" min="1"
                        max="10" step="0.1" value="5"></div>
                <div><label>Interest <span id="val_interest">5.0</span></label><input type="range" id="interest" name="interest" min="1"
                        max="10" step="0.1" value="5"></div>
                </div>
            <div class="score-display">Priority: <span id="final_score">--</span></div>
            <button type="submit" class="add-btn">INITIATE TASK</button>
        </form>
        </div>

    <ul class="task-list">
        {% for task in tasks %}
        <li class="task-card {{ task.status }}" id="card-{{ task.id }}" data-status="{{ task.status }}"
            data-start="{% if task.last_started_at %}{{ task.last_started_at.isoformat() }}{% endif %}"
            data-accumulated="{{ task.time_spent or 0 }}">
            <div class="task-header">
                <div>
                    <h3 class="task-title">{{ task.title }}</h3>
                    <div class="task-meta">
                        Priority: {{ task.priority_score|round(2) }} |
                        Time Spent:
                        <span class="live-timer" id="timer-{{ task.id }}">
                            {% set total_seconds = task.time_spent or 0 %}
                            {% set m = (total_seconds / 60)|int %}
                            {% set s = total_seconds % 60 %}
                            {{ m }}:{{ "%02d"|format(s) }}m
                        </span>
                    </div>
                </div>
            </div>

            <div class="controls">
                {% if task.status == 'active' %}
                <button class="btn btn-pause" onclick="updateState({{ task.id }}, 'pause')">‚è∏ Pause</button>
                <button class="btn btn-done" onclick="updateState({{ task.id }}, 'complete')">‚úÖ Complete</button>
                {% elif task.status != 'completed' %}
                <button class="btn btn-start" onclick="updateState({{ task.id }}, 'start')">‚ñ∂ Start Focus</button>
                {% if task.status == 'pending' or task.status == 'paused' %}
                <button class="btn btn-done" onclick="updateState({{ task.id }}, 'complete')">Done</button>
                {% endif %}
                {% else %}
                <span>Completed on {{ task.completed_at.strftime('%Y-%m-%d') }}</span>
                {% endif %}
            </div>

            {% if task.subtasks %}
            <div class="subtasks">
                {% for sub in task.subtasks %}
                <div class="subtask-item">
                    <input type="checkbox" onchange="toggleSubtask({{ sub.id }})" {% if sub.status=='completed' %}checked{% endif %}>

                    <span style="{% if sub.status == 'completed' %}text-decoration: line-through; color: #aaa;{% endif %}">
                        {{ sub.title }}
                    </span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            </li>
        {% endfor %}
    </ul>

    <div id="octo-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="modal-title">Zone Check</h2>
            <p id="modal-msg">You haven't clicked anything in a while.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modal-cancel-btn" onclick="closeModal()">I'm Good</button>
                <button class="btn btn-primary" id="modal-confirm-btn">Switch Task</button>
            </div>
        </div>
    </div>

    <script src="{{url_for('static', filename='script.js')}}"></script>

</body>

</html>